<div class="manage-shows-container">
  <div class="admin-page-header">
    <div class="admin-header-background"></div>
    <div class="admin-header-content">
      <div class="admin-header-text">
        <h1>Manage Shows</h1>
        <p>Schedule and manage movie showtimes</p>
      </div>
      <div class="admin-header-actions">
        <button class="btn-primary" (click)="addNewShow()">
          <span class="icon">+</span>
          Add New Show
        </button>
      </div>
    </div>
  </div>

  <div class="filters-section">
    <div class="search-box">
      <input type="text" placeholder="Search shows..." [(ngModel)]="searchTerm">
      <span class="search-icon">üîç</span>
    </div>

    <div class="filter-controls">
      <select [(ngModel)]="selectedMovieId">
        <option value="">All Movies</option>
        @for (movie of movies(); track movie.id) {
          <option [value]="movie.id">{{ movie.title }}</option>
        }
      </select>

      <select [(ngModel)]="selectedTheaterId">
        <option value="">All Theaters</option>
        @for (theater of theaters(); track theater.id) {
          <option [value]="theater.id">{{ theater.name }}</option>
        }
      </select>

      <input type="date" [(ngModel)]="selectedDate" class="date-filter">
    </div>

    @if (showAddForm()) {
      <div class="add-show-form">
        <div class="form-header">
          <h2>{{ isEditMode() ? 'Edit Show' : 'Add New Show' }}</h2>
          <button class="close-btn" (click)="cancelAdd()">√ó</button>
        </div>

        <form class="show-form" (ngSubmit)="saveShow()">
          <div class="form-row">
            <div class="form-group">
              <label>Movie *</label>
              <select [(ngModel)]="newShow.movieId" name="movieId" required>
                <option value="">Select Movie</option>
                @for (movie of movies(); track movie.id) {
                  <option [value]="movie.id">{{ movie.title }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Theater *</label>
              <select [(ngModel)]="newShow.theaterId" name="theaterId" (ngModelChange)="onTheaterChange()" required>
                <option value="">Select Theater</option>
                @for (theater of theaters(); track theater.id) {
                  <option [value]="theater.id">{{ theater.name }}</option>
                }
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Screen *</label>
              <select [(ngModel)]="newShow.screenId" name="screenId" (ngModelChange)="onScreenChange()" required [disabled]="!newShow.theaterId">
                <option value="">Select Screen</option>
                @for (screen of availableScreens(); track screen.id) {
                  <option [value]="screen.id">{{ screen.name }} ({{ screen.totalSeats }} seats)</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Show Date & Time *</label>
              <input type="datetime-local" [(ngModel)]="newShow.showDateTime" name="showDateTime" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Language *</label>
              <select [(ngModel)]="newShow.language" name="language" required>
                <option value="English">English</option>
                <option value="Hindi">Hindi</option>
                <option value="Tamil">Tamil</option>
                <option value="Telugu">Telugu</option>
                <option value="Malayalam">Malayalam</option>
                <option value="Kannada">Kannada</option>
              </select>
            </div>
            <div class="form-group">
              <label>Format *</label>
              <select [(ngModel)]="newShow.format" name="format" required>
                <option value="2D">2D</option>
                <option value="3D">3D</option>
                <option value="IMAX">IMAX</option>
                <option value="4DX">4DX</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Ticket Price (‚Çπ) *</label>
              <input type="number" [(ngModel)]="newShow.ticketPrice" name="ticketPrice" min="0" step="0.01" required>
            </div>
            <div class="form-group">
              <label>Total Seats *</label>
              <input type="number" [(ngModel)]="newShow.totalSeats" name="totalSeats" min="1" [disabled]="newShow.useCustomLayout" [value]="calculateTotalSeats()" required>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group full-width">
              <label class="checkbox-label">
                <input type="checkbox" [(ngModel)]="newShow.useCustomLayout" name="useCustomLayout">
                <span>Configure Custom Seat Layout with Dynamic Pricing</span>
              </label>
            </div>
          </div>

          @if (newShow.useCustomLayout) {
            <div class="seat-layout-config">
              <div class="config-header">
                <h3>Seat Layout Configuration</h3>
                <button type="button" class="btn-add-section" (click)="addSeatSection()">+ Add Section</button>
              </div>

              @if (newShow.seatLayout.length > 0) {
                <div class="seat-sections">
                  @for (section of newShow.seatLayout; track $index) {
                    <div class="seat-section">
                      <div class="section-header">
                        <h4>Section {{ $index + 1 }}</h4>
                        <button type="button" class="btn-remove" (click)="removeSeatSection($index)">√ó</button>
                      </div>
                      <div class="section-fields">
                        <div class="field">
                          <label>Section Name</label>
                          <input type="text" [(ngModel)]="section.name" [name]="'sectionName' + $index" placeholder="e.g., Regular">
                        </div>
                        <div class="field">
                          <label>Row Start</label>
                          <input type="text" [(ngModel)]="section.rowStart" [name]="'rowStart' + $index" maxlength="1" placeholder="A">
                        </div>
                        <div class="field">
                          <label>Row End</label>
                          <input type="text" [(ngModel)]="section.rowEnd" [name]="'rowEnd' + $index" maxlength="1" placeholder="B">
                        </div>
                        <div class="field">
                          <label>Seats Per Row</label>
                          <input type="number" [(ngModel)]="section.seatsPerRow" [name]="'seatsPerRow' + $index" min="1" max="20">
                        </div>
                        <div class="field">
                          <label>Price (‚Çπ)</label>
                          <input type="number" [(ngModel)]="section.price" [name]="'price' + $index" min="0" step="0.01">
                        </div>
                        <div class="field">
                          <label>Type</label>
                          <select [(ngModel)]="section.type" [name]="'type' + $index">
                            <option value="REGULAR">Regular</option>
                            <option value="PREMIUM">Premium</option>
                            <option value="VIP">VIP</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  }
                </div>

                <div class="total-seats-display">
                  <strong>Total Seats:</strong> {{ calculateTotalSeats() }}
                </div>
              }

              @if (newShow.seatLayout.length === 0) {
                <div class="empty-sections">
                  <p>No sections added yet. Click "Add Section" to configure your seat layout.</p>
                </div>
              }
            </div>
          }

          <div class="form-row">
            <div class="form-group">
              <label>Status *</label>
              <select [(ngModel)]="newShow.status" name="status" required>
                <option value="ACTIVE">Active</option>
                <option value="COMPLETED">Completed</option>
                <option value="CANCELLED">Cancelled</option>
              </select>
            </div>
            @if (!newShow.useCustomLayout) {
              <div class="form-group"></div>
            }
          </div>

          <div class="form-actions">
            <button type="button" class="btn-secondary" (click)="cancelAdd()" [disabled]="submitting()">Cancel</button>
            <button type="submit" class="btn-primary" [disabled]="submitting()">
              {{ submitting() ? (isEditMode() ? 'Updating...' : 'Saving...') : (isEditMode() ? 'Update Show' : 'Save Show') }}
            </button>
          </div>
        </form>
      </div>
    }

    @if (loading()) {
      <div class="loading-state">
        <div class="spinner"></div>
        <p>Loading shows...</p>
      </div>
    }

    @if (!loading() && filteredShows().length > 0 && !showAddForm()) {
      <div class="shows-grid">
        @for (show of filteredShows(); track show.id) {
          <div class="show-card">
            <div class="show-header">
              <div class="movie-info">
                <img [src]="show.movie?.posterUrl" [alt]="show.movie?.title" class="movie-poster"
                  (error)="onImageError($event)">
                <div class="movie-details">
                  <h3>{{ show.movie?.title }}</h3>
                  <div class="movie-meta">
                    <span class="genre">{{ show.movie?.genre?.join(', ') || 'N/A' }}</span>
                    <span class="duration">{{ show.movie?.duration || 0 }}m</span>
                    <span class="rating">{{ show.movie?.rating ?? 'N/A' }}</span>
                  </div>
                </div>
              </div>

              <div class="show-status">
                <span class="status-badge status-{{ show.status.toLowerCase() }}">
                  {{ show.status }}
                </span>
              </div>
            </div>

            <div class="show-details">
              <div class="detail-row">
                <div class="detail-item">
                  <span class="label">Theater:</span>
                  <span class="value">{{ show.theater?.name }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Screen:</span>
                  <span class="value">{{ show.screen }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Date & Time:</span>
                  <span class="value">{{ show.showDateTime | date:'MMM dd, yyyy - h:mm a' }}</span>
                </div>
              </div>

              <div class="detail-row">
                <div class="detail-item">
                  <span class="label">Price:</span>
                  <span class="value price">‚Çπ{{ show.ticketPrice }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Available Seats:</span>
                  <span class="value">{{ show.availableSeats }}/{{ show.totalSeats }}</span>
                </div>
                <div class="detail-item">
                  <span class="label">Bookings:</span>
                  <span class="value">{{ show.totalSeats - show.availableSeats }}</span>
                </div>
              </div>
            </div>

            <div class="show-actions">
              <button class="btn-secondary" (click)="editShow(show)">
                <span class="icon">‚úèÔ∏è</span>
                Edit
              </button>
              <button class="btn-secondary" (click)="viewBookings(show)">
                <span class="icon">üëÅÔ∏è</span>
                View Bookings
              </button>
              @if (show.status !== 'COMPLETED') {
                <button class="btn-danger" (click)="deleteShow(show)" 
                        [disabled]="deleteInProgressId() === show.id">
                  <span class="icon">üóëÔ∏è</span>
                  Delete
                </button>
              }
            </div>
          </div>
        }
      </div>
    }

    @if (!loading() && filteredShows().length === 0 && !showAddForm()) {
      <div class="empty-state">
        <div class="empty-icon">üé¨</div>
        <h3>No Shows Found</h3>
        <p>{{ getEmptyStateMessage() }}</p>
        @if (!hasFilters()) {
          <button class="btn-primary" (click)="addNewShow()">
            Add First Show
          </button>
        }
      </div>
    }
  </div>
</div>
